"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var t=require("liquidjs-lib"),r=require("tdex-protobuf/js/swap_pb"),n=e(require("jsbi")),o=e(require("axios")),a=require("@grpc/grpc-js"),s=require("tdex-protobuf/js/trade_grpc_pb"),i=require("tdex-protobuf/js/trade_pb");function u(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.__proto__=t}var c=function(e){this.verbose=!1,this.chain="regtest",Object.assign(this,e)},p=n.BigInt(100),d=n.multiply(p,p);function f(e){return e.slice(1).reverse().toString("hex")}function l(e){return t.confidential.confidentialValueToSatoshi(e)}function v(e,t,r,o){var a,s,i,u=n.BigInt(e),c=n.BigInt(t),p=n.BigInt(r),f=n.BigInt(100*o),l=n.multiply(u,c),v=n.add(u,p),m=n.divide(l,v),h=n.subtract(c,m),w=(s=f,i=n.multiply(n.divide(a=h,d),s),[n.subtract(a,i),i]);return n.toNumber(w[0])}function m(e,t,r,o){var a,s,i,u=n.BigInt(e),c=n.BigInt(t),p=n.BigInt(r),f=n.BigInt(100*o),l=n.multiply(u,c),v=n.subtract(c,p),m=n.divide(l,v),h=n.subtract(m,u),w=(s=f,i=n.multiply(n.divide(a=h,d),s),[n.add(a,i),i]);return n.toNumber(w[0])}function h(e){for(var t="",r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n=r.length,o=0;o<e;o++)t+=r.charAt(Math.floor(Math.random()*n));return t}function w(e){var r;try{r=t.Psbt.fromBase64(e)}catch(e){throw new Error("Invalid psbt")}var n=r.data.globalMap.unsignedTx.toBuffer();return{psbt:r,transaction:t.Transaction.fromBuffer(n)}}var y=function(e){function t(){return e.apply(this,arguments)||this}u(t,e);var n=t.prototype;return n.request=function(e){var t=e.assetToBeSent,n=e.amountToBeSent,o=e.assetToReceive,a=e.amountToReceive,s=e.psbtBase64,i=new r.SwapRequest;return i.setId(h(8)),i.setAmountP(n),i.setAssetP(t),i.setAmountR(a),i.setAssetR(o),i.setTransaction(s),g(i),this.verbose&&console.log(i.toObject()),i.serializeBinary()},n.accept=function(e){var t=e.psbtBase64,n=r.SwapRequest.deserializeBinary(e.message),o=new r.SwapAccept;return o.setId(h(8)),o.setRequestId(n.getId()),o.setTransaction(t),g(n,o),this.verbose&&console.log(o.toObject()),o.serializeBinary()},n.complete=function(e){var t=e.message,n=e.psbtBase64;if(!w(n).psbt.validateSignaturesOfAllInputs())throw new Error("Signatures not valid");var o=r.SwapAccept.deserializeBinary(t),a=new r.SwapComplete;return a.setId(h(8)),a.setAcceptId(o.getId()),a.setTransaction(n),this.verbose&&console.log(o.toObject()),a.serializeBinary()},t}(c);function g(e,t){var r=w(e.getTransaction());if(x(r.psbt.data.inputs,e.getAssetP())<e.getAmountP())throw new Error("Cumulative utxos count is not enough to cover SwapRequest.amount_p");if(!b(r.transaction.outs,e.getAmountR(),e.getAssetR()))throw new Error("Either SwapRequest.amount_r or SwapRequest.asset_r do not match the provided psbt");if(t){var n=w(t.getTransaction());if(e.getId()!==t.getRequestId())throw new Error("SwapRequest.id and SwapAccept.request_id are not the same");if(x(n.psbt.data.inputs,e.getAssetR())<e.getAmountR())throw new Error("Cumulative utxos count is not enough to cover SwapRequest.amount_r");if(!b(n.transaction.outs,e.getAmountP(),e.getAssetP()))throw new Error("Either SwapRequest.amount_p or SwapRequest.asset_p do not match the provided psbt")}}function b(e,t,r){return void 0!==e.find((function(e){return l(e.value)===t&&f(e.asset)===r}))}function x(e,t){return e.filter((function(e){return f(e.witnessUtxo.asset)===t})).map((function(e){return l(e.witnessUtxo.value)})).reduce((function(e,t){return e+t}),0)}y.parse=function(e){var t,n=e.message,o=e.type;try{t=r[o].deserializeBinary(n)}catch(e){throw new Error("Not valid message of expected type "+o)}return JSON.stringify(t.toObject(),void 0,2)};var B=function(e,t){try{return Promise.resolve(o.get(t+"/address/"+e+"/utxo")).then((function(e){return e.data}))}catch(e){return Promise.reject(e)}},k=function(){function e(e){var r=e.network,n=t.payments.p2wpkh({address:e.address,network:r});this.network=r,this.address=n.address,this.script=n.output.toString("hex")}return e.prototype.updateTx=function(e,r,n,o,a,s){var i,u=this;try{i=t.Psbt.fromBase64(e)}catch(e){throw new Error("Invalid psbt")}var c=function(e,t){for(var r=[],n=0,o=0;o<e.length;o++){var a=e[o];if(r.push({txid:a.txid,vout:a.vout,value:a.value,asset:a.asset}),(n+=a.value)>=t)break}if(n<t)throw new Error("You do not have enough in your wallet");return{unspents:r,change:n-t}}(r=r.filter((function(e){return e.asset===a})),n),p=c.change;return c.unspents.forEach((function(e){return i.addInput({hash:e.txid,index:e.vout,witnessUtxo:{script:Buffer.from(u.script,"hex"),asset:Buffer.concat([Buffer.from("01","hex"),Buffer.from(a,"hex").reverse()]),value:t.confidential.satoshiToConfidentialValue(e.value),nonce:Buffer.from("00","hex")}})})),i.addOutput({script:Buffer.from(this.script,"hex"),value:t.confidential.satoshiToConfidentialValue(o),asset:Buffer.concat([Buffer.from("01","hex"),Buffer.from(s,"hex").reverse()]),nonce:Buffer.from("00","hex")}),p>0&&i.addOutput({script:Buffer.from(this.script,"hex"),value:t.confidential.satoshiToConfidentialValue(p),asset:Buffer.concat([Buffer.from("01","hex"),Buffer.from(a,"hex").reverse()]),nonce:Buffer.from("00","hex")}),i.toBase64()},e}();k.fromAddress=function(e,r){var n=r?t.networks[r]:t.networks.liquid;try{return new k({address:e,network:n})}catch(e){throw new Error("fromAddress: Invalid address or network")}},k.createTx=function(e){return new t.Psbt({network:e?t.networks[e]:t.networks.liquid}).toBase64()},k.toHex=function(e){var r;try{r=t.Psbt.fromBase64(e)}catch(e){throw new Error("Invalid psbt")}return r.validateSignaturesOfAllInputs(),r.finalizeAllInputs(),r.extractTransaction().toHex()};var T=function(e){function r(r){var n,o=r.keyPair;return(n=e.call(this,{network:r.network,address:r.address})||this).updateTx=e.prototype.updateTx,n.keyPair=o||t.ECPair.makeRandom({network:n.network}),n.privateKey=n.keyPair.privateKey.toString("hex"),n.publicKey=n.keyPair.publicKey.toString("hex"),n}return u(r,e),r.prototype.sign=function(e){var r,n=this;try{r=t.Psbt.fromBase64(e)}catch(e){throw new Error("Invalid psbt")}return r.data.inputs.forEach((function(e,t){if(e.witnessUtxo.script.toString("hex")===n.script&&(r.signInput(t,n.keyPair),!r.validateSignaturesOfInput(t)))throw new Error("Invalid signature")})),r.toBase64()},r}(k);T.fromWIF=function(e,r){var n=r?t.networks[r]:t.networks.liquid;try{var o=t.ECPair.fromWIF(e,n),a=t.payments.p2wpkh({pubkey:o.publicKey,network:n});return new T({keyPair:o,network:n,address:a.address})}catch(e){throw new Error("fromWIF: Invalid keypair")}},T.fromRandom=function(e){var r=e?t.networks[e]:t.networks.liquid;try{var n=t.ECPair.makeRandom({network:r}),o=t.payments.p2wpkh({pubkey:n.publicKey,network:r});return new T({keyPair:n,network:r,address:o.address})}catch(e){throw new Error("fromRandom: Failed to create wallet")}};var P,A=function(){function e(e){this.providerUrl=e,this.client=new s.TradeClient(e,a.credentials.createInsecure())}var t=e.prototype;return t.tradePropose=function(e,t,n){var o=this,a=e.baseAsset,s=e.quoteAsset;return new Promise((function(e,u){var c=new i.Market;c.setBaseAsset(a),c.setQuoteAsset(s);var p=new i.TradeProposeRequest;p.setMarket(c),p.setType(t),p.setSwapRequest(r.SwapRequest.deserializeBinary(n));var d,f=o.client.tradePropose(p);f.on("data",(function(e){var t=e.getSwapAccept();d=t.serializeBinary()})),f.on("end",(function(){return e(d)})),f.on("error",(function(e){return u(e)}))}))},t.tradeComplete=function(e){var t=this;return new Promise((function(n,o){var a=new i.TradeCompleteRequest;a.setSwapComplete(r.SwapComplete.deserializeBinary(e));var s,u=t.client.tradeComplete(a);u.on("data",(function(e){s=e.getTxid()})),u.on("end",(function(){return n(s)})),u.on("error",(function(e){return o(e)}))}))},t.markets=function(){var e=this;return new Promise((function(t,r){e.client.markets(new i.MarketsRequest,(function(e,n){if(e)return r(e);var o=n.getMarketsList().map((function(e){return e.getMarket()})).map((function(e){return{baseAsset:e.getBaseAsset(),quoteAsset:e.getQuoteAsset()}}));t(o)}))}))},t.balances=function(e){var t=this,r=e.baseAsset,n=e.quoteAsset,o=new i.Market;o.setBaseAsset(r),o.setQuoteAsset(n);var a=new i.BalancesRequest;return a.setMarket(o),new Promise((function(e,o){t.client.balances(a,(function(t,a){var s;if(t)return o(t);var i=a.getBalancesList().find((function(e){return e.getAsset()===r})).getAmount(),u=a.getBalancesList().find((function(e){return e.getAsset()===n})).getAmount(),c={fee:a.getFee(),balances:(s={},s[r]=i,s[n]=u,s)};e(c)}))}))},e}();(P=exports.TradeType||(exports.TradeType={}))[P.BUY=0]="BUY",P[P.SELL=1]="SELL";var S=function(e){function t(t){var r;if(!(r=e.call(this,t)||this).chain)throw new Error("To be able to trade you need to select the network via { chain }");if(!r.providerUrl)throw new Error("To be able to trade you need to select a liquidity provider via { providerUrl }");if(!r.explorerUrl)throw new Error("To be able to trade you need to select an explorer via { explorerUrl }");return r.grpcClient=new A(r.providerUrl),r}u(t,e);var n=t.prototype;return n.buy=function(e){var t=e.market,r=e.amount,n=e.address,o=e.privateKey;try{var a=this;if(!o&&!n)throw new Error("Either private key or native segwit address is required");if(o){var s=T.fromWIF(o,a.chain);return Promise.resolve(a.marketOrderRequest(t,exports.TradeType.BUY,r,s)).then((function(e){return Promise.resolve(a.marketOrderComplete(e,s))}))}var i=k.fromAddress(n,a.chain);return Promise.resolve(a.marketOrderRequest(t,exports.TradeType.BUY,r,i))}catch(e){return Promise.reject(e)}},n.sell=function(e){var t=e.market,r=e.amount,n=e.address,o=e.privateKey;try{var a=this;if(!o&&!n)throw new Error("Either private key or native segwit address is required");if(o){var s=T.fromWIF(o,a.chain);return Promise.resolve(a.marketOrderRequest(t,exports.TradeType.SELL,r,s)).then((function(e){return Promise.resolve(a.marketOrderComplete(e,s))}))}var i=k.fromAddress(n,a.chain);return Promise.resolve(a.marketOrderRequest(t,exports.TradeType.SELL,r,i))}catch(e){return Promise.reject(e)}},n.preview=function(e,t,r){try{if((a=r)<=0||!Number.isSafeInteger(a))throw new Error("Amount is not valid");var n=e.baseAsset,o=e.quoteAsset;return Promise.resolve(this.grpcClient.balances({baseAsset:n,quoteAsset:o})).then((function(e){if(t===exports.TradeType.BUY){var a=o,s=n,i=r;if(i>e.balances[s])throw new Error("Amount exceeds market balance");return{assetToBeSent:a,amountToBeSent:m(e.balances[a],e.balances[s],i,e.fee),assetToReceive:s,amountToReceive:i}}var u=n,c=o,p=r;if(p>e.balances[u])throw new Error("Amount exceeds market balance");return{assetToBeSent:u,amountToBeSent:p,assetToReceive:c,amountToReceive:v(e.balances[u],e.balances[c],p,e.fee)}}))}catch(e){return Promise.reject(e)}var a},n.marketOrderRequest=function(e,t,r,n){try{var o=this;return Promise.resolve(o.preview(e,t,r)).then((function(r){var a=r.assetToBeSent,s=r.amountToBeSent,i=r.assetToReceive,u=r.amountToReceive;return Promise.resolve(B(n.address,o.explorerUrl)).then((function(r){var c=T.createTx(o.chain),p=n.updateTx(c,r,s,u,a,i),d=(new y).request({assetToBeSent:a,amountToBeSent:s,assetToReceive:i,amountToReceive:u,psbtBase64:p});return Promise.resolve(o.grpcClient.tradePropose(e,t,d))}))}))}catch(e){return Promise.reject(e)}},n.marketOrderComplete=function(e,t){try{var n=r.SwapAccept.deserializeBinary(e).getTransaction(),o=t.sign(n),a=(new y).complete({message:e,psbtBase64:o});return Promise.resolve(this.grpcClient.tradeComplete(a))}catch(e){return Promise.reject(e)}},t}(c);Object.defineProperty(exports,"networks",{enumerable:!0,get:function(){return t.networks}}),exports.Swap=y,exports.Trade=S,exports.TraderClient=A,exports.Wallet=T,exports.WatchOnlyWallet=k,exports.calculateExpectedAmount=v,exports.calculateProposeAmount=m,exports.fetchBalances=function(e,t){try{return Promise.resolve(B(e,t)).then((function(e){return e.reduce((function(e,t){var r=t.asset;return e[r]=e[r]||0,e[r]+=t.value,e}),{})}))}catch(e){return Promise.reject(e)}},exports.fetchUtxos=B;
//# sourceMappingURL=tdex-sdk.cjs.production.min.js.map
